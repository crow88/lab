"use strict";define([window.Game.js_url_list.tone,window.Game.js_url_list.util,window.Game.js_url_list.bar_line_sprite,window.Game.js_url_list.tone_sprite,window.Game.js_url_list.renda_sprite,window.Game.js_url_list.special_sprite,window.Game.js_url_list.const,window.Game.js_url_list.combo_count,window.Game.js_url_list.effect_circle,window.Game.js_url_list.special_draw,window.Game.js_url_list.fever,window.Game.js_url_list.option_storage],function(t,e,i,s,a,n,r,_,h,o,c,p){var l=function(i){this.parent=i,this.lane_stage=i.lane_stage,this.sheet=i.songData.notes,this.use_date=i.use_date,this.special_keys=Object.keys(t.Special),this.calculate=e.calculate,this.use_calculate=!0,this.speed=r.SPEED,this.speed_multiply=1/this.speed,this.millisecond_per_plus=1e-6*Math.floor(r.NORMAL_LENGTH*this.speed_multiply*1e6),this.end_position=r.END_POINT/this.millisecond_per_plus,this.frame_per_plus=this.millisecond_per_plus*(r.ONE_SECOND/r.FPS),this.sprite_manager=i.sprite_manager,this.display_tone_start=0,this.display_tone_end=0,this.previous_position=0,this.create_count=0,this.balloon_draw=new o(this,"balloon",4),this.kusudama_draw=new o(this,"kusudama"),this.combo_count=new _,this.effect_circle=null,p.canUseEffect(this.parent.songData.option.effect_circle)&&(this.effect_circle=new h(this.lane_stage,this.sprite_manager,this.parent.soul_effect)),this.fever=new c(this.parent),this.shift_list=[],this.shift_line_list=[],this.task_callactions=[],this.sprite_data={},this.sprite_data.bar_line=[];for(var s in t)for(var a in t[s])this.sprite_data[a]=[];this.State=r.State,this.tick=this.previous_tick,this.init()},f=l.prototype;return f.init=function(){var e={Type:8,Combo:1,Special:3};this.sprite_data.bar_line.push(new i(this.lane_stage,this.sprite_manager)),this.sprite_data.bar_line.push(new i(this.lane_stage,this.sprite_manager));for(var r=0;r<e.Combo;r++)for(var _ in t.Combo)this.sprite_data[_].push(new a(_,this.lane_stage,this.sprite_manager)),this.sprite_data[_][this.sprite_data[_].length-1].create_id=this.create_count++;for(var r=0;r<e.Type;r++)for(var _ in t.Type)this.sprite_data[_].push(new s(_,this.lane_stage,this.sprite_manager)),this.sprite_data[_][this.sprite_data[_].length-1].create_id=this.create_count++;for(var r=0;r<e.Combo;r++)for(var _ in t.Combo)this.sprite_data[_].push(new a(_,this.lane_stage,this.sprite_manager)),this.sprite_data[_][this.sprite_data[_].length-1].create_id=this.create_count++;for(var r=0;r<e.Special;r++)for(var _ in t.Special)this.sprite_data[_].push(new n(_,this.lane_stage,this.sprite_manager,this[_+"_draw"])),this.sprite_data[_][this.sprite_data[_].length-1].create_id=this.create_count++;this.effect_circle&&this.effect_circle.makeCache()},f.createNotes=function(e,i){var s=this.sheet[e];s.bar_line&&this.createBarLine(s,i),"0"===s.fever?this.fever.set_finish(s):s.fever&&this.fever.set_start(s),$.inArray(s.type,this.special_keys)>-1?this.createSpecial(s,i):s.type.indexOf(t.Combo.renda)>-1?this.createRenda(s,i):s.type&&this.createTone(s,i)},f.previous_tick=function(t){this.effect_circle?this.effect_circle_tick=this.use_effect_circle_tick:this.effect_circle_tick=e.doNoting,this.use_calculate?(this.spriteUpdate=this.spriteCalulateUpdate,this.tick=this.hybrid_tick):(this.use_date?this.get_time=this.using_date_time:this.get_time=this.using_position_time,this.previous_position=this.get_time(),this.spriteUpdate=this.spriteDelayUpdate,this.tick=this.use_delay_tick)},f.using_position_time=function(t){return t},f.using_date_time=function(){return Date.now()},f.use_delay_tick=function(t){var e=this.get_time(t),i=e-this.previous_position,s=i*this.millisecond_per_plus;this.nextSearch(t),this.draw(t,s),this.drawLine(t,s),this.fever.update(t),this.effect_circle_tick(t),this.previous_position=e,this.lane_stage.update()},f.hybrid_tick=function(t){(this.shift_list.length||this.shift_line_list.length)&&this.lane_stage.update();var e=this;setTimeout(function(){e.effect_circle_tick(t+r.QUARTER_FPS)},r.QUARTER_FPS),setTimeout(function(){var i=t+r.ONE_FPS;e.nextSearch(i),e.draw(i),e.drawLine(i),e.fever.update(i)},r.HALF_FPS)},f.calcultae_tick=function(t){this.nextSearch(t),this.draw(t),this.drawLine(t),this.fever.update(t),this.effect_circle_tick(t),this.lane_stage.update()},f.use_effect_circle_tick=function(t){this.effect_circle.tick(t)},f.nextSearch=function(t){if(void 0!=t)for(;this.searchProcess(t);)this.createNotes(this.display_tone_end-1,t)},f.searchProcess=function(t){var e=!1,i=this.sheet[this.display_tone_end];if(void 0==i)return e;var s=i.time-t;return s<=this.speed&&(this.display_tone_end++,e=!0),e},f.findWaitSprite=function(t){var e=null;for(var i in this.sprite_data[t])if(this.sprite_data[t][i].state==this.State.Wait){e=i;break}return e},f.sprite_init=function(t,e,i,s){var a=this.sprite_data[t][e];a.state=this.State.Fall;var n=this.calculate(i.time,s);if(a.setXposition(n),"bar_line"==t)return a.state=this.State.Fall,a.note=null,a.time=i.time,void this.shift_line_list.push(a);if(this.shift_list.push(a),i.extension)a.setTailXposition(this.calculate(i.extension,s));else{for(var _ in this.parent.decision.Judge){var h=this.parent.decision.Judge[_],o=parseInt(i.time);a.judge[_][r.DECISION_UO.under]=o-h.rate,a.judge[_][r.DECISION_UO.over]=o+h.rate}a.use_combo=!0}a.show(),a.note=i,i.state=this.State.Fall},f.createBarLine=function(t,e){var s=this.findWaitSprite("bar_line");null===s&&(this.sprite_data.bar_line.push(new i(this.lane_stage,this.sprite_manager)),s=this.sprite_data.bar_line.length-1),this.sprite_init("bar_line",s,t,e)},f.createTone=function(t,e){if(void 0==this.sprite_data[t.type])return void console.log(t.type+" is not found");var i=this.findWaitSprite(t.type);null===i&&(this.sprite_data[t.type].push(new s(t.type,this.lane_stage,this.sprite_manager)),i=this.sprite_data[t.type].length-1),this.sprite_init(t.type,i,t,e)},f.createRenda=function(t,e){var i=this.findWaitSprite(t.type);null===i&&(this.sprite_data[t.type].push(new a(t.type,this.lane_stage,this.sprite_manager)),i=this.sprite_data[t.type].length-1),this.sprite_init(t.type,i,t,e)},f.createSpecial=function(t,e){var i=this.findWaitSprite(t.type);null===i&&(this.sprite_data[t.type].push(new n(t.type,this.lane_stage,this.sprite_manager,this[t.type+"_draw"])),i=this.sprite_data[t.type].length-1),this.sprite_init(t.type,i,t,e)},f.draw=function(t,e){for(var i in this.shift_list){var s=this.shift_list[i];switch(this.spriteUpdate(s,t,e)){case r.DELETE_COMBO:s.use_combo=!1,this.parent.decision.comboCount("bad"),this.parent.bg_effect.make_stream_effect("bad"),this.fever.is_fever()||"bad"==this.parent.bg_effect.current_animation_name||this.parent.bg_effect.setup_animation("bad");break;case r.END_TONE:this.changeToWait(s,this.State.End)}}},f.drawLine=function(t,e){for(var i in this.shift_line_list){var s=this.shift_line_list[i];this.spriteUpdate(s,t,e)&&this.changeToWait(s,this.State.End)}},f.spriteDelayUpdate=function(t,e,i){return t.delayUpdate(i,e)},f.spriteCalulateUpdate=function(t,e){return t.update(e)},f.changeToWait=function(e,i){var s=this;setTimeout(function(){if(e.state=s.State.Wait,e.note){e.hide();var a=e.note;a.state==s.State.Fall&&(a.state=i);var n=s.shift_list.indexOf(e);n!=-1&&s.shift_list.splice(n,1),e.originType==t.Combo.renda&&s.combo_count.deleteRenda()}else{var n=s.shift_line_list.indexOf(e);n!=-1&&s.shift_line_list.splice(n,1)}},r.QUARTER_FPS)},f.hitCurrentTone=function(e,i,s){var a=this.findHitIndex(i);if(null!==a){var n=a.type.indexOf("str")>-1;if("special"==a.originType){if(e==t.Type.ka)return;var _=this[a.type+"_draw"].makeSpecial(a,i);return void this.parent.score.update_special(a.type,_,this.fever.is_fever())}if("renda"==a.originType)return this.combo_count.addRenda(),this.parent.score.update_renda(n,this.fever.is_fever()),void(this.effect_circle&&this.effect_circle.throwEffect(e+(n?"_str":"")));if("tone"==a.originType){if(a.type.indexOf(e)==-1)return;for(var h in this.parent.decision.Judge){var o=a.judge[h];if(o[r.DECISION_UO.under]<=i&&o[r.DECISION_UO.over]>=i){var c=this.parent.decision.Judge[h].name;this.hitTone(a,c,n,s,e);break}}}}},f.hitTone=function(t,e,i,s,a){this.changeToWait(t,this.State.Catch);var n=this.parent.decision,_=this.parent.bg_effect,h=this;if(n.showJudge(e),n.comboCount(e),this.parent.gauge.is_max()&&"full_wait"!=_.current_animation_name&&!this.fever.is_fever()&&setTimeout(function(){_.setup_animation("full_wait")},r.QUARTER_FPS),void 0!==this.parent.cjs_notes&&setTimeout(function(){h.parent.cjs_notes.cjs004_notes_01.gotoAndPlay(e)},r.QUARTER_FPS),_.make_stream_effect(e),"bad"!=e){if("key"==s)if(i){var o=$.Deferred(),c=this.fever.is_fever(),p=e,l=this.combo_count.combo,f=this.parent[a+"Deferred"];f.push(o),o.promise().done(function(){h.parent.score.update(p,c,!0,!0,l),f.shift()}).fail(function(){h.parent.score.update(p,c,!1,!1,l),f.shift()}),setTimeout(function(){o.reject(),f.splice(0,f.length)},r.DUAL_PUSH_DELAY_MS)}else this.parent.score.update(e,this.fever.is_fever(),!1,!1);else this.parent.score.update(e,this.fever.is_fever(),i,s);this.effect_circle&&setTimeout(function(){h.effect_circle.throwEffect(t.type)},r.QUARTER_FPS),"bad"==_.current_animation_name&&setTimeout(function(){_.update_fever(h.fever.is_fever())},r.QUARTER_FPS),this.combo_count.combo&&this.combo_count.combo%10===0&&setTimeout(function(){_.setup_animation("good")},r.QUARTER_FPS),this.combo_count.combo&&this.combo_count.combo%100===0&&setTimeout(function(){h.parent.score.justUpdate()},r.QUARTER_FPS)}else this.fever.is_fever()||"bad"==_.current_animation_name||setTimeout(function(){_.setup_animation("bad")},r.QUARTER_FPS)},f.findHitIndex=function(t){var e=null;for(var i in this.shift_list){var s=this.shift_list[i];if(s.note.state==this.State.Fall)if(s.note.extension){if(s.note.time-r.RENDA_RATE<=t&&parseInt(s.note.extension)+r.RENDA_RATE>=t){e=s;break}}else{var a=s.judge[r.DECISION_KEY.bad];if(a[r.DECISION_UO.under]<=t&&a[r.DECISION_UO.over]>=t){e=s;break}}}return e},l});