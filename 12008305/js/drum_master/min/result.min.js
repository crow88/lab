"use strict";define(["underscore","jquery","backbone",window.Game.js_url_list.fader,window.Game.js_url_list.network,window.Game.js_url_list.const,window.Game.js_url_list.gauge,window.Game.js_url_list.option_storage,window.Game.js_url_list.popup,window.Game.js_url_list.cjs008_gauge_result_01,window.Game.js_url_list.cjs009_cutin_result_01,window.Game.js_url_list.util],function(t,e,s,a,i,n,o,r,u,_,l,c){var d=window.createjs,f=1/12*1e3,h=s.View.extend({el:"#drum_master",template:t.template(e("#result_template").html()),template_form:t.template(e("#result_form_template").html()),events:{"click .result_display":"openPopup"},initialize:function(s,n,o,r,u){this.result_data=s,this.bg_effect=n,this.songData=o,this.canvas_util=r,this.playPart=u,this._timer=0;var _=e.Deferred(),l=e.Deferred(),c=this;this.ajaxDeferred=l,a.addEventListener("fadeoutComplete",function(){e("#drum_master").empty(),c.$el.html(c.template_form({result_data:c.result_data.attributes})),c.ajaxResult(),_.resolve()}),this.network=new i(function(t){c.result_data.set("is_best_score",t.is_best_score),l.resolve()}),a.fadeout(),e.when(_.promise(),l.promise()).done(function(){c.render(),d.Ticker.addEventListener("tick",t.bind(c.tick,c)),c.fadein()})},ajaxResult:function(){var t=this.$el.find("#result_network");this.network.send(t[0].action,t.serialize())},fadein:function(){a.addEventListener("fadeinComplete",t.bind(this.animationStart,this)),a.fadein(),e(".don_area").append(this.bg_effect.get_don().css({"-webkit-transform":"scale(1.2)"})),this.bg_effect.setup_animation("wait")},render:function(){var t={great_success:1,success:2,dear:3,failure:4};this.$el.html(this.template({result_data:this.result_data.attributes,word:t})),this.init_gauge(),this.init_result_effect()},init_gauge:function(){this.gauge_stage=new d.Stage(document.getElementById("soul_gauge_result")),this.canvas_util.adjustCanvasSize(this.gauge_stage,.5*(1/n.lane_zoom)),this.gauge=new o(r.canUseEffect(this.songData.option.rainbow)),this.gauge.init(this.gauge_stage,this.songData.info.level,(new window.lib.cjs008_gauge_result_01).cjs008_gauge_result_01);for(var t=0;t<this.result_data.attributes.gauge_num;t++)this.gauge.add(t==this.result_data.gauge_num-1);this.playPart.setGauge(this.gauge)},init_result_effect:function(){this.result_effect_stage=new d.Stage(document.getElementById("result_effect2")),this.canvas_util.adjustCanvasSize(this.result_effect_stage,.5*(1/n.lane_zoom));var t=new window.lib.cjs009_cutin_result_01;this.result_effect_stage.addChild(t),this.result_effect_stage.update(),this.result_effect=t.cjs009_cutin_result_01,this.result_effect.x+=320,this.result_effect.y+=280,window.result_effect=this.result_effect},tick:function(){Date.now()-this._timer>f&&(this._timer=Date.now(),this.result_effect_stage.update())},openPopup:function(){void 0!=this.popup&&(c.playSE("ka"),this.popup.open())},animationStart:function(){function t(){switch(C.clear_type){case"fullcombo":S.setup_animation("result_good");break;case"great_success":S.setup_animation("result_good");break;case"success":S.setup_animation("result_good");break;case"dear":S.setup_animation("result_close_1");break;case"failure":S.setup_animation("result_bad")}switch(C.clear_type){case"fullcombo":case"great_success":z.result_effect.star.gotoAndPlay("on");case"success":z.result_effect.flower.gotoAndPlay("on")}y.on("webkitTransitionEnd",function(){z.popup=new u({music_id:z.songData.info.id,difficulty:z.songData.info.level})}),y.addClass("_appear")}function s(){m.show().addClass("_anim_appear2")}function a(){d(k,C.max_combo)}function i(){d(j,C.renda)}function n(){d(b,C.bad)}function o(){d(v,C.good)}function r(){d(p,C.excellent)}function _(){w.show().addClass("_anim_appear3")}function l(){h.show().addClass("_anim_appear3")}function c(){f(g,C.score)}function d(t,e){function s(){n+=o,n=Math.ceil(n),n<e?(a(i,n.toString()),setTimeout(s,50)):a(i,e.toString())}function a(t,e){for(var s,a=t.size(),i=0;i<e.length;i++)s=e.length-i-1,t.eq(a-s-1).removeClass().addClass("no_"+e[i]).show()}var i=t.find("div"),n=0,o=e/6;t.show(),e<=0||(i.hide(),s())}function f(t,e){function s(){o=++o%10,o>0?(a(i,o.toString(),n),setTimeout(s,20)):(a(i,u.toString(),n),o=0,n++,u=r[r.length-1-n],n<r.length&&setTimeout(s,20))}function a(t,e,s){var a=t.size();t.eq(a-s-1).removeClass().addClass("no_"+e).show()}var i=t.find("div"),n=0,o=0;if(t.show(),!(e<=0)){var r=e.toString(),u=r[r.length-1-n];i.hide(),s()}}var h=e(".best_score_icon"),m=e(".clear_result_image"),g=e(".result_score"),w=e(".crown_icon"),p=e(".score_excellent"),v=e(".score_good"),b=e(".score_bad"),j=e(".score_renda"),k=e(".score_max_combo"),y=(e(".don"),e(".don_word")),C=this.result_data.attributes,S=this.bg_effect,D=[{animation:"none",wait:0}];C.is_best_score&&D.push({animation:l,wait:500}),C.crown&&D.push({animation:_,wait:500}),D.push({animation:c,wait:200+200*C.score.toString().length}),D.push({animation:r,wait:300}),D.push({animation:o,wait:300}),D.push({animation:n,wait:300}),D.push({animation:i,wait:300}),D.push({animation:a,wait:800}),D.push({animation:s,wait:500}),D.push({animation:t,wait:500});for(var G=0,x=1;x<D.length;x++)G+=D[x-1].wait,function(){var t=D[x];setTimeout(function(){t.animation()},G)}();var z=this}});return h});