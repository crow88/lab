"use strict";define(["underscore","backbone","util/event_converter","play/util/device_checker",window.Game.js_url_list.sprite_manager,window.Game.js_url_list.sound_loader,window.Game.js_url_list.bg_effect,window.Game.js_url_list.canvas_util,window.Game.js_url_list.tone_iterator,window.Game.js_url_list.decision,window.Game.js_url_list.const,window.Game.js_url_list.cjs004_notes_01,window.Game.js_url_list.cutin,window.Game.js_url_list.gauge,window.Game.js_url_list.paper_ball,window.Game.js_url_list.soul_effect,window.Game.js_url_list.result_effect,window.Game.js_url_list.result,window.Game.js_url_list.score,window.Game.js_url_list.fader,window.Game.js_url_list.util,window.Game.js_url_list.option_storage],function(t,e,s,i,o,n,a,c,h,r,_,u,d,l,f,g,m,p,w,v,b,S){var T={INIT:"init",WAIT_START:"wait_start",STARTING:"starting",PLAYING:"playing"},y={don0:["don",0],don1:["don",1],ka0:["ka",0],ka1:["ka",1],"":["",0]},k=1e3,I=3200,E="lane",D="notes_effect",C="cutin",j="stream_effect",G="gauge",P="soul",N="result_effect",R="paper_ball",A="score_effect",O=window.createjs,B=window.boombox,x=e.View.extend({el:"#drum_master",template:t.template($("#dm_play_template").html()),keycodes:{68:"don",83:"don",74:"ka",75:"ka"},keycodeOn:{68:!1,83:!1,74:!1,75:!1},keylinkcodes:{68:83,83:68,74:75,75:74},keyLR:{68:"r",83:"l",74:"l",75:"r"},initialize:function(t){this.donDeferred=[],this.kaDeferred=[],this._note_effect_timer=0,this.timestamp=0,this.sprite_manager=o,this.songData=t,this.use_ready=!1,this.notes_effect_flag=!1,void 0!=this.songData.hit_zone&&(_.HIT_ZONE_WIDTH=this.songData.hit_zone);var i=e.Model.extend({defaults:{info:this.songData.info,level_name_list:{1:"easy",2:"normal",3:"hard"},stage_option:this.songData.option,perfomance:S.getPerfomance()}});this.songDataBackbone=new i,this.isTouchDevice=s.isTouchDevice(),U(this.isTouchDevice),this.currentState=T.INIT,this.canvas_util=new c,this.effect_id="effect",this.startTime=null,this.use_date=!1,this.use_webgl=!1,this.loadBgm()},loadBgm:function(){window.Game.useBoombox?(this.getInstance=this.getInstanceBoombox,this.ready()):(this.getInstance=this.getInstanceSoundjs,this.getPosition=window.use_date?this.getPositionUseDate:this.getPositionUseSoundjs,n.loadSound("bgm",window.Game["bgmUrl"+this.songData.info.id]).done(t.bind(this.ready,this)).fail(function(){alert("読み込みに失敗しました。")}))},boomboxPlayBgm:function(){if(this.boomboxBgm)return void this.boomboxBgm.replay();var e={src:[{media:"audio/mpeg",path:window.Game["bgmUrl"+this.songData.info.id]+(window.chrome?"&v2="+Date.now():"")}]},s=this;try{B.load("bgm",e,window.Game.use_video,function(e,i){window.Game.use_video&&$("#video").append(i.$el),s.boomboxBgm=B.get("bgm"),s.boomboxBgm.onEnded=t.bind(s.finishProcess,s),s.use_ready=!0,s.$touch_start.find("span").addClass("play_start")})}catch(t){console.log("load fail")}},render:function(){this.$el.html(this.template(this.songDataBackbone.attributes))},ready:function(){var e=this;this.tick=this.standardTick,O.Ticker.addEventListener("tick",t.bind(this.tick,this)),_.ORIGIN_FPS==_.FPS&&(O.Ticker.timingMode=O.Ticker.RAF),O.Ticker.setFPS(_.FPS),this.render(),null==this.$disp_fps&&(this.$disp_fps=$("#disp_fps")),window.scrollTo(0,1),this.isTouchDevice?($("#game_center").on("touchstart",t.bind(this.onTouchStart,this)),$("#game_center").on("touchend",t.bind(this.onTouchEnd,this)),window.Game.ua.isChromeApp()&&$("#game_center").on("mousedown",t.bind(this.onKeydown,this))):$("#game_center").on("mousedown",t.bind(this.onKeydown,this)),(window.chrome||window.Game.ua.isChromeApp())&&($(document).on("keydown",t.bind(this.onKeyboard,this)),$(document).on("keyup",t.bind(this.offKeyboard,this)),console.log("pc keyboard"));var s=this.use_webgl?"SpriteStage":"Stage";this.lane_stage=new O[s](document.getElementById(E)),this.canvas_util.adjustCanvasSize(this.lane_stage,1/_.lane_zoom,this.use_webgl),S.canUseEffect(this.songData.option.cutin)&&(this.cutin_stage=new O.Stage(document.getElementById(C)),this.canvas_util.adjustCanvasSize(this.cutin_stage,.5),this.cutin=new d,this.cutin.init(this.cutin_stage,this.songData.status[b.convertKeyName(this.songData.info.level)].idol_appear_timing)),this.score_effect_stage=null,S.canUseEffect(this.songData.option.score)&&(this.score_effect_stage=new O.Stage(document.getElementById(A)),this.canvas_util.adjustCanvasSize(this.score_effect_stage,.23*(1/_.lane_zoom))),this.gauge_stage=new O.Stage(document.getElementById(G)),this.canvas_util.adjustCanvasSize(this.gauge_stage,.5*(1/_.lane_zoom)),this.gauge=new l(S.canUseEffect(this.songData.option.rainbow)),this.gauge.init(this.gauge_stage,this.songData.info.level,(new window.lib.cjs003_gauge_01).cjs003_gauge_01,this.cutin),this.result_effect_stage=new O.Stage(document.getElementById(N)),this.canvas_util.adjustCanvasSize(this.result_effect_stage,.5),this.result_effect=new m,this.result_effect.init(this.result_effect_stage),S.canUseEffect(this.songData.option.kusudama_animation)&&(this.paper_ball_stage=new O.Stage(document.getElementById(R)),this.canvas_util.adjustCanvasSize(this.paper_ball_stage,.5),this.paper_ball=new f,this.paper_ball.init(this.paper_ball_stage)),this.soul_effect=null,S.canUseEffect(this.songData.option.soul)?(this.soul_stage=new O.Stage(document.getElementById(P)),this.canvas_util.adjustCanvasSize(this.soul_stage,.5),this.soul_effect=new g,this.soul_effect.init(this.soul_stage),this.soul_stage_tick=t.bind(this.soul_effect.soul_stage_tick,this.soul_effect)):this.soul_stage_tick=b.doNoting,this.tone_iterator=new h(this),this.decision=new r(this.tone_iterator.combo_count,this.songData,this.gauge,this.soul_effect),this.score=new w(this.decision.status,this.tone_iterator.combo_count,S.canUseEffect(this.songData.option.score),this.score_effect_stage),S.canUseEffect(this.songData.option.goal)?(this.notes_effect_stage=new O.Stage(document.getElementById(D)),this.canvas_util.adjustCanvasSize(this.notes_effect_stage,.5/_.lane_zoom),this.cjs_notes=new window.lib.cjs004_notes_01,this.cjs_notes.scaleX=1*_.lane_zoom,this.cjs_notes.scaleY=1*_.lane_zoom,this.notes_effect_stage.addChild(this.cjs_notes),this.notes_effect_tick=this.notes_effect_stage_update):(this.notes_effect_tick=b.doNoting,this.fire_sprite=new O.Bitmap(o.toneDom.fire),this.fire_sprite.x=12*_.lane_zoom,this.fire_sprite.y=5*_.lane_zoom,this.fire_sprite.scaleX=.3*_.lane_zoom,this.fire_sprite.scaleY=.3*_.lane_zoom),this.bg_effect=new a(this.songData.animation_list,this.gauge),S.canUseEffect(this.songData.option.stream)&&(this.stream_effect_stage=new O.Stage(document.getElementById(j)),this.canvas_util.adjustCanvasSize(this.stream_effect_stage,.5),this.bg_effect.init(this.stream_effect_stage)),this.$touch_don_l=$("#touch_don_l"),this.$touch_don_r=$("#touch_don_r"),this.$touch_ka_l=$("#touch_ka_l"),this.$touch_ka_r=$("#touch_ka_r"),this.$touch_start=$("#touch_start"),this.$result_effect=$(".result_effect"),setTimeout(function(){if(window.Game.useBoombox)e.boomboxPlayBgm();else if(0!=S.getSeSetting()||window.chrome){var t=navigator.userAgent;if(window.Game.ua.isShallApp()&&t.match(/Android [4-9]|Android [0-9][0-9]/)&&t.match(/Chrome/))e.use_ready=!0,e.$touch_start.find("span").addClass("play_start");else{O.Sound.stop();var s=O.Sound.createInstance("bgm");s.play(window.createjs.Sound.INTERRUPT_NONE,0,0,0,1)}}else e.use_ready=!0,e.$touch_start.find("span").addClass("play_start");e.currentState=T.STARTING},k),v.fadein(),this.debug_canvas=document.getElementById("develop_canvas"),this.debugStage(this.debug_canvas)},notes_effect_stage_update:function(t){t-this._note_effect_timer<=_.FPS_INTERVAL_6||(this._note_effect_timer=t,this.notes_effect_stage.update())},notes_effect_stage_judge:function(t){t-this._note_effect_timer<=_.FPS_INTERVAL_6||(this._note_effect_timer=t,this.notes_effect_flag=!0)},notes_effect_flag_tick:function(){this.notes_effect_flag&&(this.notes_effect_flag=!1,this.notes_effect_stage.update())},onTouchStart:function(t){t.preventDefault();var e=t.originalEvent.changedTouches[0].pageX-this.$el[0].offsetLeft,s=t.originalEvent.changedTouches[0].pageY-this.$el[0].offsetTop;if(window.Game.ua.isChromeApp()){var i=$("html").css("zoom");e/=i,s/=i}this.onTouchOrKey(e,s)},onKeydown:function(t){if(this.touchStamp&&100>t.timeStamp-this.touchStamp)return void(this.touchStamp=0);var e=t.originalEvent.pageX-this.$el[0].offsetLeft,s=t.originalEvent.pageY-this.$el[0].offsetTop;if(window.Game.ua.isChromeApp()){var i=$("html").css("zoom");e/=i,s/=i}this.onTouchOrKey(e,s)},onKeyup:function(t){},onTouchEnd:function(t){window.Game.ua.isChromeApp()&&(this.touchStamp=t.timeStamp),this.use_ready&&i.isIos9_012(navigator.userAgent)&&this.playTouchstart()},onKeyboard:function(t){var e=t.keyCode;if(this.debug_canvas&&this.currentState==T.STARTING&&(49==e?O.Ticker.removeAllEventListeners():50==e&&(O.Sound.stop(),this.finishProcess())),void 0!=this.keycodes[e]&&!this.keycodeOn[e]){this.keycodeOn[e]=!0;var s=this.keycodes[e];if(this.keycodeOn[this.keylinkcodes[e]]){var i=this[s+"Deferred"].shift();if(i)return i.resolve(),void this.onHitProgress(s,"lr",1);if(t.timeStamp-this.timestamp<60)return void(this.timestamp=0)}else this.timestamp=t.timeStamp;this.hitProgress(s,"key",this.keyLR[e],this.getInstance())}},offKeyboard:function(t){var e=t.keyCode,s=this.keycodes[e];void 0!=s&&(this.keycodeOn[e]=!1,b.rejecter(this[s+"Deferred"]))},onTouchOrKey:function(t,e){var s=this.decision.getHitType(t,e);if(""!=s){var i=t>_.HIT_ZONE_IN_DRUM_X?"r":"l";this.hitProgress(y[s][0],y[s][1],y[s][1]?"lr":i,this.getInstance())}},hitProgress:function(t,e,s,o){if(this.use_ready)return void(window.Game.useBoombox&&this.boomboxBgm&&0==this.boomboxBgm.$el.currentTime?(this.boomboxPlayBgm(),this.$touch_start.empty(),this.use_ready=!1):i.isIos9_012(navigator.userAgent)||this.playTouchstart());if(t.length){this.currentState!=T.INIT&&this.tone_iterator.hitCurrentTone(t,o,e);var n=this;setTimeout(function(){b.playSE(t),n.onHitProgress(t,s,e)},_.QUARTER_FPS)}},playTouchstart:function(){if(void 0!=this.$touch_start){this.$touch_start.empty(),this.use_ready=!1,O.Sound.stop();var t=O.Sound.createInstance("bgm");t.play(O.Sound.INTERRUPT_NONE,0,0,0,1)}},onHitProgress:function(t,e,s){for(var i in e){var o="$touch_"+t+"_"+e[i];1===s&&this[o].addClass("str"),this[o].show(),this.offHitProgress(o)}},offHitProgress:function(t){var e=this;setTimeout(function(){e[t].removeClass().hide()},75)},standardTick:function(){var t=Date.now(),e=this.getInstance(t);if(null!==e&&this.tone_iterator.tick(e),this.soul_stage_tick(t),this.notes_effect_tick(t),this.gauge.tick(t),S.canUseEffect(this.songData.option.score)&&this.score.tick(t),S.canUseEffect(this.songData.option.donchan)&&this.bg_effect.tick(t),S.canUseEffect(this.songData.option.cutin)&&this.cutin.tick(t),S.canUseEffect(this.songData.option.kusudama_animation)&&this.paper_ball.tick(),this.result_effect.tick(),this.$disp_fps.length){var s=this;setTimeout(function(){s.$disp_fps.text(Math.round(O.Ticker.getMeasuredFPS()))},_.QUARTER_FPS)}},getInstanceBoombox:function(){if(this.boomboxBgm){var t=null;return void 0!=this.boomboxBgm.state.time.playback&&(t=1e3*this.boomboxBgm.$el.currentTime,null===this.startTime&&(this.startTime=t)),t}},getInstanceSoundjs:function(e){if(void 0==this.soundJsInstance){var s=O.Sound._instances[0];s&&s.src.indexOf("bgm")>-1&&(this.soundJsInstance=s,s.addEventListener("complete",t.bind(this.finishProcess,this)))}return this.getPosition(e)},getPositionUseDate:function(t){var e=null;return null===this.startTime&&(this.startTime=t),e=t-this.startTime},getPositionUseSoundjs:function(){if(void 0==this.soundJsInstance)return null;var t=null;return null===this.startTime&&(this.startTime=this.soundJsInstance.getPosition()),t=this.soundJsInstance.getPosition()},finishProcess:function(){if(null!==this.startTime){this.startTime=null,this.tick=b.doNoting,this.$result_effect.show();var e=this.decision.getResult(),s=this.decision.is_fullcombo(this.tone_iterator.combo_count.max_combo);s?this.result_effect.fullcombo():"failure"==e||"dear"==e?this.result_effect.fail():this.result_effect.success(),this.result_effect.addEventListener("resultAnimationComplete",t.bind(this.chagneResultTerm,this))}},chagneResultTerm:function(){var t=this;setTimeout(function(){t.changeResult()},I)},changeResult:function(){$("#game_center").unbind("touchstart"),$("#game_center").unbind("mousedown"),$(document).unbind("keydown");var t=this.decision.getResult(),s="";switch(t){case"great_success":case"success":s="silver"}var i=this.decision.is_fullcombo(this.tone_iterator.combo_count.max_combo);i&&(s="gold");var o=e.Model.extend({defaults:{id:this.songData.info.id,difficulty:this.songDataBackbone.attributes.level_name_list[this.songData.info.level],difficulty_numeric:this.songData.info.level,is_best_score:!1,clear_type:t,score:this.score.total_point.toString(),crown:s,gauge_num:this.gauge.num.toString(),excellent:this.decision.getDecision("excellent").toString(),good:this.decision.getDecision("good").toString(),bad:this.decision.getDecision("bad").toString(),renda:this.tone_iterator.combo_count.max_renda.toString(),max_combo:this.tone_iterator.combo_count.max_combo.toString()}}),n=new o;new p(n,this.bg_effect,this.songData,this.canvas_util,this)},setGauge:function(t){this.gauge=t},debugStage:function(t){if(t&&S.getLineSetting()){$(t).show(),this.debug_stage=new O.Stage(t),this.canvas_util.adjustCanvasSize(this.debug_stage);var e=new O.Shape;e.graphics.beginStroke("#0000ff").drawCircle(_.GOAL_X,_.GOAL_Y,_.MS_PX*this.songData.judge.excellent),this.lane_stage.addChild(e);var s=new O.Shape;s.graphics.beginStroke("#00ff00").drawCircle(_.GOAL_X,_.GOAL_Y,_.MS_PX*this.songData.judge.good),this.lane_stage.addChild(s);var i=new O.Shape;i.graphics.beginStroke("#ff0000").drawCircle(_.GOAL_X,_.GOAL_Y,_.MS_PX*this.songData.judge.bad),this.lane_stage.addChild(i);var o=new O.Shape;o.graphics.beginStroke("#ff0000").drawCircle(_.HIT_ZONE_IN_DRUM_X,_.HIT_ZONE_IN_DRUM_Y,_.HIT_ZONE_WIDTH),this.debug_stage.addChild(o);var n=new O.Shape;n.graphics.beginStroke("#ff0000").moveTo(0,_.HIT_ZONE_TOP).lineTo(_.LANE_WIDTH,_.HIT_ZONE_TOP),this.debug_stage.addChild(n);var a=new O.Shape;a.graphics.beginStroke("#ff0000").drawCircle(_.EFFECT_CIRCLE_X,_.EFFECT_CIRCLE_Y,_.EFFECT_CIRCLE_RADIUS),this.lane_stage.addChild(a);var c=new O.Shape;c.graphics.beginStroke("#ff0000").drawCircle(_.EFFECT_GOAL_X,_.EFFECT_GOAL_Y,20),this.lane_stage.addChild(c);var h=new O.Shape;h.graphics.beginStroke("#ff0000").drawCircle(_.HIT_ZONE_IN_DRUM_X,_.HIT_ZONE_IN_DRUM_Y,this.decision.don_pure),this.debug_stage.addChild(h);var r=new O.Shape;r.graphics.beginStroke("#ff0000").drawCircle(_.HIT_ZONE_IN_DRUM_X,_.HIT_ZONE_IN_DRUM_Y,this.decision.ka_pure),this.debug_stage.addChild(r),this.debug_stage.update()}}}),U=function(t){$(document.body).attr(t?"ontouchmove":s.convertToMouse("ontouchmove"),"event.preventDefault();");var e="onwheel"in document?"wheel":"onmousewheel"in document?"mousewheel":"DOMMouseScroll";$(document).on(e,function(t){t.preventDefault()}),$(document).on("touchmove.noScroll",function(t){t.preventDefault()})};return x});